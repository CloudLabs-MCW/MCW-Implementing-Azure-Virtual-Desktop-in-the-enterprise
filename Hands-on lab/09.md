![image](https://github.com/shashankms9/MCW-Implementing-Azure-Virtual-Desktop-in-the-enterprise/assets/104433795/ee016593-5ee9-46eb-955f-663e8f521eaf)## Exercise 9: Improving your AVD environment

Duration:  60 minutes

In this exercise, you will our AVD experience bay utilizing additional features or tools with the host pools. AVD is designed to be a versatile platform to distribute and build your solution from, and these optional features allow you to enhance and/or secure the environment depending on your needs. By the end of this exercise, you will have the following features enabled:

- Autoscale pooled pool based on connections

- Centralized Application Management (MSIX App Attach)

- Protect your environment via Microsoft Defender for Endpoint


**Additional Resources**

| Description | Links |
|----------|:-------------:|
| Scale session hosts using Azure Automation | https://docs.microsoft.com/en-us/azure/virtual-desktop/set-up-scaling-script |
| Set up MSIX app attach with the Azure portal |  https://docs.microsoft.com/en-us/azure/virtual-desktop/app-attach-azure-portal |
| Prepare an MSIX image for Azure Virtual Desktop | https://docs.microsoft.com/en-us/azure/virtual-desktop/app-attach-image-prep |
| MSIX Packaging Tool | https://docs.microsoft.com/en-us/windows/msix/packaging-tool/tool-overview |
| Onboard Windows 10 multi-session devices in Windows Virtual Desktop | https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/Onboard-Windows-10-multi-session-device?view=o365-worldwide |
| Azure Cloud Shell | https://docs.microsoft.com/en-us/azure/cloud-shell/overview |

### Task 1: Configure permissions for Autoscale

In this task, we'll configure the permissions necessary to enable auto scall in Azure Virtual Desktop.

1. Navigate to the Azure Portal, and the subscription Azure Virtual Desktop is running in.

2. Select Access control (AIM). Select **+ Add** and **Add custom role**.

    ![Selecting to add a custom role in the Access Control for your Azure subscription.](images/addcustomrole.png "Adding a custom role to an Azure Subscription")

3. Enter a role name as **AVD Autoscale** and description, then select **Next**.

    ![Enter the custom role andm and description for the new AVD Autoscale role in the subscription.](images/avdcustomrolebasics.png "Create a custom AVD Role Basics tab")

4. On the permissions tab, select **Next**; we aren't adding any permissions yet.

5. On the assignable scopes tab, select **Next**.

6. On the JSON tab, select **Edit**, then copy and paste the JSON below into the "actions": [] array.

    ```JSON
    "Microsoft.Insights/eventtypes/values/read",
    "Microsoft.Compute/virtualMachines/deallocate/action",
    "Microsoft.Compute/virtualMachines/restart/action",
    "Microsoft.Compute/virtualMachines/powerOff/action",
    "Microsoft.Compute/virtualMachines/start/action",
    "Microsoft.Compute/virtualMachines/read",
    "Microsoft.DesktopVirtualization/hostpools/read",
    "Microsoft.DesktopVirtualization/hostpools/write",
    "Microsoft.DesktopVirtualization/hostpools/sessionhosts/read",
    "Microsoft.DesktopVirtualization/hostpools/sessionhosts/write",
    "Microsoft.DesktopVirtualization/hostpools/sessionhosts/usersessions/delete",
    "Microsoft.DesktopVirtualization/hostpools/sessionhosts/usersessions/read",
    "Microsoft.DesktopVirtualization/hostpools/sessionhosts/usersessions/sendMessage/action"
    ```

    ![The JSON from above correctly entered into the custom role definition settings with the Save button highlighted.](images/editjson.png)

7. Select **Save**, **Review + Create**, then **Create**.

8. Now, we need to assign the role to the Azure Virtual Desktop service principal. Back on the **Access control (AIM)** settings for the subscription, select **+ Add** and **Add role assignment**.

    ![Adding a role assignment for the newly created custom role within the Access control for the Azure subscription.](images/addroleassignment.png "Add role assignment in Azure subscription")

9. Select the **AVD Autoscale** custom role we just created and select **Next**.

    ![Selecting the new AVD Autoscale role so it can be assigend to a user.](images/assigncustomrole.png "Select the new custom role")

10. Select **+ Select members**, search for and select **Azure Virtual Desktop**.

    ![Selecting the Azure Virtual Desktop service principal so it will be assigend the AVD Autoscale role.](images/selectazurevirtualdesktop.png "Select the Azure Virtual Desktop service principal")

11. Select **Review + assign**, then **Review + Create**

### Task 2: Enabling Autoscale

In this task, you will enable the scaling of your pool based on the number of connections. Azure Virtual Desktop allows you to create scaling plans which will enable us to automatically increase and decrease the number of hosts in an AVD host pool based on the demand of the environment.

1. Navigate to the Azure Portal and go to Azure Virtual Desktop.

2. Select **Scaling plans** under **Manage**, then select **Create scaling plan**.

    ![The Scaling plans in Azure virtual desktop with the button highlighted to Create a scaling plan.](images/createscalingplan.png "Create a new AVD scaling plans")

3. Select the resource group and location for Azure Virtual Desktop. Then give your scaling plan a friendly name and select **Next: Schedules >**.

    - Resource Group: *Select **AVD-RG** from the drop down*.
    - Name : **avdpoolscaling**.
    - Region: **East US**, *this should be the same as the location of your resource group*.  
    - Friendly name: **AVD Host Pool Scaling** 

    ![The basic settings for the scaling plan are highlighted.](images/scallerplan.png "AVD Scaling Plan Basics")

4. Select **+ Add schedule**. Keep the defaults in General and select **Next**.

    ![This image shows the general settings for a new schedule.](images/scalingschedulegeneral.png "General settings for a new scaling schedule")

5. Within Ramp-up, review the settings, but we'll take the default settings again. Start time entails two things, the start of when you start to power on VMs and the end time of off-peak hours. Minimum is the minimum percentage of VMs that should be powered on starting at this time. The capacity threshold is what percentage of capacity needs to be used before another virtual machine is powered on. For example, with a pool of 10 VMs and a capacity of 20 sessions, at 8:00 am, a minimum of two VMs would be on. Once you get to 12 active sessions, a 3rd virtual machine will be powered on. Select **Next**.

    ![The Ramp-Up settings when adding a schedule for autoscale. Showing the default settings for Start Time, Load blanacing algorithm, Minimum percentage of hosts, and capacity threshold.](images/scalingschedulerampup.png "Schedule settings for ramp-up")

6. Peak hours is another one we won't make any changes to, but review the settings. The minimum number of VMs turned on will carry over from ramp-up as well as the capacity threshold.

    ![The Peak hours settings when adding a schedule for autoscale. Showing the Start time, Load balancing algorithm and capacity threshold.](images/scalingschedulepeakhours.png "Schedule settings for peak hours")

7. Ramp down is the time you want to start shutting down virtual machines and is the end of peak hours. Here the minimum percentage of hosts should be smaller than ramp-up and peak hours as you want to start shutting down virtual machines. The default is 10 percent, meaning in a pool of 10 virtual machines, you want to leave no less than 1 VM powered on. The capacity threshold will turn virtual machines on if you hit it, but this should be a larger number, so you aren't powering on virtual machines as you try to ramp down. The final set of settings is around logging users out. To shut down virtual machines, users need to log off and shift their sessions to other hosts. These settings allow you to configure if the user logout is forced, how long after they log out the machine is shut down, and the message given to users. Leave all settings the default and select **Next**.

    ![The Ramp-down settings when adding a schedule for autoscale. Showing the default settings for Start time, Load balancing algorithm, minimum percentage of hosts, capacity threshold, force logoff users, delay time before logging out users and notification message.](images/scalingschedulerampdown.png "Schedule settings for ramp-down")

8. Off-peak hours is the time that ramp-down will end and will also take the capacity threshold from the ramp-down settings. This capacity threshold takes the higher value from ramp-down as you don't want machines powered on during off-peak hours unless necessary. The off-peak hours will end when the next ramp-up time starts. Select **Add**.

    ![The Off-peak hours settings when adding a schedule for autoscale. Showing the default settings for Start time and Load balancing algorithm.](images/scalingscheduleoffpeak.png "Schedule settings for off-peak hours.")

9. You'll see your new schedule added to the scaling plan schedule. Select **Next: Host pool assignments >**.

    ![The new schedule added to the AVD scaling plan.](images/scalingschedule.png "Schedule added to the scaling plan")

10. Select your load balanced host pool in the drop-down, ensure **Enable autoscale** is selected, select **Review + create**, then select **Create**.

    ![Selecing the host pool to add the autoscale settings to and select the checkbox to enable autoscale.](images/scalingplancreate.png "Create the scaling plan")

At this point, your AVD Host Pool that is Pooled will spin up and down hosts based on the environment's load.

### Task 3: Utilizing Application Packages (MSIX)

In this task, you will take an **MSIX package** created from the [MSIX packaging tool](https://docs.microsoft.com/en-us/windows/msix/packaging-tool/tool-overview) and utilize the Azure portal to attach the MSIX package dynamically to AVD pools as users log in. MSIX Packages are disk images containing all files, configurations, and publication details needed to run supported applications that can be mounted by Windows systems on the fly to allow users to run the application without having to install the application on the host machine. By utilizing this technique, we can minimize the footprint and management needs of the AVD hosts while still using multiple applications on the systems without installing the applications permanently on the system.

1. Go to the [Azure Portal](https://portal.azure.com/).

    ![This image shows the Azure Portal home web page.](images/azureportal.png "Azure Portal")

2. Go to the **Storage Account** and select **<inject key="Storage Account Name" />** created in Exercise 3 for the FSLogix profiles already joined to Active Directory.

3. Select the **File shares** under data storage and select the **avafiles** share created for AVD files.

    ![This image shows you will open share for AVD File Share on the storage account.](images/storageaccountfile.png "AVD File Share")

4. Select the **Browser** and Select the **MSIX**. Ensure the **MSIX** directory you created earlier is there; if not, go back to Exercise 3, Tasks 4-6, and follow the steps to create it.

    ![This image shows the Azure Portal home web page.](images/msixfolder.png "Azure Portal")

   > **Note:** Normally, in production, you would create an additional share for MSIX files and place the files there. You would need to make sure the share or container the MSIX files are in you follow the same steps you use for the FSLogix storage account and apply the appropriate permissions to them (users typically only need Read access) and make sure there is enough room to store them. We are placing it on the same share for this exercise for expediency and easier setup. It is not uncommon to have a central MSIX storage with permissions to each MSIX file based on groups assigned to the appropriate application and the MSIX repository used by multiple pools or deployments but ensure network connectivity and speed are kept consistent.

5. In a new tab in your browser, navigate to [https://github.com/microsoft/MCW-Implementing-Azure-Virtual-Desktop-in-the-enterprise/blob/main/Hands-on%20lab/resources/VHD/](https://github.com/microsoft/MCW-Implementing-Azure-Virtual-Desktop-in-the-enterprise/blob/main/Hands-on%20lab/resources/VHD/) and download AVD-MSIX.vhd.

6. Back in your storage account, upload the .VHD file to the MSIX folder.

    ![Select Upload file and upload the AVD-MSIX.vhd file to the file share.](images/avdmsixfileupload.png "Upload AVD-MSIX.vhd")

7. The MSIX images on the VHD have been signed with Device Guard v2; for it to work, the root certificate needs to be installed on the servers used for publishing the apps. These servers don't have a public IP address, so we'll use the domain controller as a jump box to the app servers. First, create a remote desktop session to the domain controller.

8. Get the IP address from the first server in your remote app pool. It should be something like 10.1.0.8.

    ![The IP address of the first virtual machine in the remote app pool is highlighted.](images/ipappserver.png "The private IP address of the server")

9. On the domain controller, open Remote Desktop Connection and connect to the IP address of your first remote app server. You can use the avdadmin account you set up as a local admin when creating the server by entering **/avdadmin** for the username.

    ![The remote desktop connection on the domain controller with the IP address of the first remote app server is shown.](images/connecttoappserver.png "Remote desktop connection to the first remote app server")

10. Once you're logged into the first app server, open up Microsoft Edge and navigate to the following URL:

    ```text
    https://www.microsoft.com/pkiops/certs/microsoft%20enterprise%20identity%20verification%20root%20certificate%20authority%202020.crt
    ```

11. Open the downloaded certificate; this root certificate is needed to verify the MSIX packages. Select **Open** when the Security Warning is shown.

    ![In Microsoft Edge, select "open file" for the downloaded certificate.](images/downloadcertificate.png "Download the certificate from the URL in Edge")

    ![Select open from the Security Warning dialog that pops up.](images/opencertificate.png "Select Open in the Security Warning")

12. With the certificate opened, select **Install Certificate...**.

    ![Install the certificate by selecting Install Certificate...](images/installcertificate.png "Select Install Certificate...")

13. In the Certificate Import Wizard, select **Local Machine** for the Store Location. Then select **Next**.

    ![Choose Local Machine for the Storage location in the Import Wizard.](images/localmachinecertificate.png "Install the certificate in the Local Machine store")

14. On the wizard's next step, select **Place all certificates in the following store**. Then select **Browser** and **Trusted Root Certification Authorities**. Select **Next**.

    ![Choose to place all certificates in the following source, then browse to trusted root certification authorities.](images/trustedrootcertificate.png "Place the certificate in Trusted Root Certification Authorities")

15. Select **Finish**, and you'll see a dialog that the import was completed successfully.

    ![Select the Finish button to complete the certificate import.](images/finishcertificateinstall.png "Finish the Certificate import")

    ![Confirmation dialog that the certificate import was completed successfully.](images/succesfulcertimport.png "Succesful certificate import dialog")

16. Restart virtual machine. Repeat steps 8 - 16 on the second remote app server in the pool to import the certificate there also.

    >**Note**: In a larger image, this certificate import could be done in the Gold Image used for provisioning machines or incorporated into the provisioning of any new app servers in the pool.

17. Once the certificate has been successfully imported into both remote app servers and they have both been rebooted, navigate back to **Azure Virtual Desktop** in the Azure portal.

18. Select **Host Pools**, your remote app pool, **MSIX packages**, and then **+ Add**.

    ![In Azure Virtual Desktop, Host pools is highlighted, then the remote app pool. Followed by MSIX package and then the + Add button.](images/navigatetomsix.png "The links to click to navigate and add a new MSIX package")

19. In the MSIX image path, paste the file share path to your MSIX file. It should be in the format below. After pasting it in, wait a few seconds, and the rest of the dialog boxes should appear. Replace **storage account name** with **<inject key="Storage Account Name" />** and **share name** with **avafiles**.  

    ```text
    \\<storage account name>.file.core.windows.net\<share name>\msix\AVD-MSIX.vhd.
    ```

20. Select **Firefox** in the MSIX package, type **Firefox** into the Display Name, and set the State to **Active**. Then select **Add**.

    ![Fill in the path to the .vhd file, select the Firefox package, set the display name to Firefox, and make the app active.](images/addfirefoxpackage.png "Add the Firefox MSIX package")

21. Repeat steps 19 and 20 to add the NotePad++ package using the same path to the .vhd file and configure the settings for Notepad++ with the following settings.

    - MSIX image path: the path to the network share containing you .vhd file. The same path from step 19.
    - MSIX package: Select your NotepadPlusPlus package from the dropdown
    - Display name: Notepad++
    - State: Active

    ![Fill in the path to the .vhd file, select the Notepadd++ package, set the display name to Notepad++ and make the app active.](images/addnotepadpackage.png "Add the Notepad++ MSIX package")

22. In **Azure Virtual Desktop**, select **Application groups** under Manage, then select your **remoteapps** group.

23. Within your **remoteapps** group, select **Applications** and **+Add**.

    ![Select +Add to add a new remote app to your group.](images/addnewmsixapp.png "Add a new remote app")

24. Set the Application source to **MSIX package**, select **Firefox**, and provide an Application name of **Firefox**. Select Save.

    ![Set the application source to MSIX package, select the firefox application, name it Firefox and select the Save button.](images/addfirefoxapplication.png "Adding the Firefox application")

25. Repeat steps 23 and 24 to add the Notepad++ application.

26. You should have Firefox and Notepad++ added as available applications now.

    ![Firefox and Notepad++ are highlighted in the list of available applications. They have an application type of MSIX.](images/msixapplicationsadded.png "Firefox and Notepad++ added to the list of applications")

27. Go to the [AVD Web Client](https://rdweb.wvd.microsoft.com/arm/webclient) (or AVD client if installed locally) and login as one of your end users.

28. Select the new application icon to launch the application (refresh the page if the new application does not show up).

    ![The notepad++ application published from the MSIX package is running in the browser.](images/notepadplusplus.png "Notepad++ running as a published app")

This application is now running on the host pool, although it is not installed on the host system. This allows the application to be updated by changing which MSIX package the application points to and the next time a user logs into the application.

### Task 4: Protect AVD with Microsoft Defender for Endpoint

In this task, you will enable Microsoft Defender for Endpoint service and deploy the endpoint protection via Azure. This enables all systems to be protected by the Microsoft Defender for Endpoint service from potential vulnerabilities and alerts in the event of suspicious execution or activity.

>**Note:** This will require signing up for [Azure Defender trial](https://docs.microsoft.com/en-us/azure/security-center/enable-azure-defender#to-enable-azure-defender-on-your-subscriptions-and-workspaces) on your subscription. If this is a Visual Studio subscription or you do not want to sign up for the time trial yet, you will need to wait and deploy this when you can sign up for the Azure Defender trial.

1. Go to the [Azure Portal](https://portal.azure.com/).

    ![This image shows the Azure Portal home page.](images/azureportal.png "Azure Portal")

2. Open **Microsoft Defender for Cloud**.

    ![In this image, you are searching and navigating to Microsoft Defender for Cloud.](images/findAsc.png "Microsoft Defender for Cloud")

3. Select **Upgrade** on the **Getting started** page.

    ![The skip link is highlighted next to the Upgrade button. This bypasses the trial upgrade.](images/skipupgrade.png "Skip the 30 day trial upgrade")

4. Go to the **Workload protections** under the Cloud Security section.

5. Select **Enable Microsoft Defender for Cloud** to set up the trial edition of Azure Defender for your subscription.

    ![This image shows how to navigate to the Azure Defender section to enable the trial of Azure Defender.](images/enableAzureDefender.png "Enable Azure Defender")

6. Select Upgrade to start the 30-day trial upgrade you skipped earlier. You could also have upgraded from the initial Getting Started page.

    !["Select the Upgrade button to enroll in the 30-day trial of Microsoft Defender for Cloud enhance security features.](images/upgradedefender.png "Upgrade Microsoft Defender for Cloud")

7. Select **Install agents** to deploy the security agents to your virtual machines. You'll also see the count of unprotected resources in the entire subscription.

    !["The install agents button is highlighted that can be clicked to deploy the Microsoft Defender for Cloud agent to the unprotected VMs](images/installagents.png "Install agents")

8. Refresh the **Workload protections** screen. At the top, you should see all your resources in the subscription now fully covered.

    ![Workload protection shows Defender for Cloud coverage as 11 of 11 resources being fully protected.](images/fullprotectedresources.png "Fully covered workloads")

9. It can take some time for agents to deploy fully, but if you let it run for a while, you'll start seeing your resources show up in the Inventory.

    !["One of the application pool virtual machines is shown in the Microsoft Defender for Cloud inventory"](images/defenderinventory.png "Microsoft Defender for Cloud Inventory")

10. Depending on your AVD environment, you can deploy them to systems as they are added to your domain in the AVD OU by utilizing Group Policies using the [domain group policy scenario](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/onboard-windows-10-multi-session-device?view=o365-worldwide#scenario-2-using-domain-group-policy). Another option when your host is not persistent or deployed from an image, is to use the instructions for [onboarding non-persistent VDI devices](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/configure-endpoints-vdi?view=o365-worldwide).
 
